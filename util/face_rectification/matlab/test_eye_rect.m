%% Test one image
clear; close all;
canon_corresp = [587.7176330459509, 342.7476405513655; 588.9558846564667, 368.7643541763323; 591.863434642277, 394.7076349058793; 596.1711205103779, 419.7266960795117; 604.1258390248872, 443.1355407784548; 618.3636524264871, 462.8516017485819; 638.1656343118194, 477.7800116591783; 661.3934429395769, 487.9612686755753; 687.049528272902, 489.8081341487156; 713.5719905430129, 486.3271806539459; 737.529157363659, 475.2105498411111; 758.4312779166132, 459.6945963262378; 773.5327243541495, 439.3119555372978; 781.0082228363751, 414.786014820013; 784.2435014664591, 388.3173427595111; 785.6171934418643, 360.9290687395242; 785.7152259934139, 333.5826441694332; 604.2854989819126, 295.6631633626015; 614.1883308220739, 287.2075866892223; 626.5407845608339, 283.1706366698885; 639.4642736851822, 282.4121451353624; 652.0316360648542, 284.4630984924656; 703.8882195777758, 282.0299744051492; 718.0388773049199, 278.3737175915438; 732.7758632040848, 277.8464646400226; 747.1595137511036, 281.4753587822852; 759.041666956316, 290.1958650773186; 678.5616250488556, 317.5287917635603; 678.5720421445729, 331.3178560605718; 678.5599042911687, 344.9103336525699; 678.5882973272044, 358.4064885557022; 663.2407843581487, 378.6180334207222; 671.6742626756402, 380.0446448251446; 680.2988874881612, 380.3091407426704; 689.6757078099303, 379.1948713890157; 698.8546363289777, 376.9468357283238; 619.2848247210961, 324.4166817917347; 628.3840175947514, 317.9722135053797; 639.7388652347501, 317.5547821208553; 649.2763318954696, 322.7308180226477; 639.552964665531, 326.4588548945104; 628.9536850949563, 327.3547003069162; 713.3880411446627, 319.5760889972977; 722.6348483852422, 313.3776130187288; 734.2796085463079, 313.1089365237959; 744.2212545948894, 318.6467343192301; 734.4988978837505, 322.3328223358028; 723.6222645899469, 322.4527491411528; 644.0745717813173, 421.3002614803346; 655.8824773964285, 413.2575387092972; 668.7691864819398, 407.3630009712266; 682.4825686295311, 407.7000309522036; 696.9865811132568, 406.041789150096; 711.4118925164167, 410.7128299891685; 725.3909724813499, 417.2993956339208; 714.0776177900822, 427.4430689625441; 699.6940452817863, 433.5252762420394; 684.1058407160663, 435.4304363650195; 669.0850904203481, 435.1106988472729; 654.9873343191731, 430.475707866092; 666.0653189671883, 418.1932727853313; 682.9912677264042, 417.4262120962647; 701.1168791998045, 416.4471577979711; 701.7326193972747, 420.4807747951872; 683.3266729125991, 421.9978736805865; 665.8037431700117, 422.2073851631581];
turned_corresp = [592.3926479024265, 357.6660492180379; 595.1121460262436, 382.8266428054494; 599.6434026623149, 407.8538458840508; 604.4843515477792, 431.2813381645344; 611.6168900091909, 452.2164765307122; 623.7428608025227, 468.3177898107872; 641.2346600054623, 479.5834016837268; 661.642889836124, 486.5690415792526; 683.821409492205, 486.2512494046418; 711.6425111069655, 482.447971194629; 737.2077043098417, 471.8616366242979; 760.109223027813, 457.1900065671627; 778.3910199073397, 438.4029282632263; 788.9836420281425, 415.7275014796467; 793.5297823838797, 391.1483135770877; 794.3729595452595, 365.3810440033697; 793.8368354321542, 339.7930596960113; 592.3608191998093, 302.7238138697339; 601.6282800845069, 290.8057641434519; 614.8975096519354, 284.3498374816504; 629.362469115616, 282.8873148105233; 643.5154782173272, 285.2677083926992; 691.1111347389111, 280.5131574319166; 706.8045248440849, 275.6314062726144; 723.4413426322427, 274.5085800350925; 739.7632353348912, 278.7235243103823; 753.0733313651303, 289.1217984171135; 670.3103971249323, 318.4584083088877; 669.4390389859776, 331.7872432187336; 668.3859801368324, 344.9049266650121; 667.30625531602, 357.9051250406673; 656.1875395935842, 378.3184334330219; 664.4667196545753, 379.416587549954; 672.9493839437107, 379.1109012875792; 682.6294096774542, 377.6987929126862; 691.933686297382, 374.9319414765546; 610.4510418391933, 332.958583390755; 619.5020539316819, 326.0686380431185; 630.9929955951425, 324.5308095919462; 641.5178208911196, 328.4678874188338; 631.4929181937, 332.9071550257685; 620.6558593943513, 334.5903490886382; 704.5464450582975, 322.8907220671223; 714.1395123687685, 316.9500089384605; 726.1891287091765, 316.2197695606641; 736.7553395897797, 321.2534047631585; 726.3785966778537, 324.864788987238; 715.1889419101789, 325.2651578658395; 639.6353662747954, 420.243342661381; 649.896472087932, 411.0540475384852; 661.7836116483084, 404.1857827853138; 674.7088050985063, 403.4102727059475; 690.0778533970637, 401.5344661938983; 705.3834112711464, 405.8548855435825; 720.0787909614576, 412.7241377967123; 708.6990538627197, 422.8539549525343; 694.0104106208605, 429.0690757593583; 678.0102067554827, 431.3410244445894; 663.9316562752899, 431.8251848753101; 650.488639288382, 428.1756339190732; 660.9777683247718, 415.2288572522064; 675.8935610779897, 413.358107965444; 694.4278647401115, 412.1327969622563; 695.7293284850089, 416.2572223718325; 677.1311503874897, 418.1860686117117; 661.3311068598611, 419.4238474303198];
im_canon = imread('/Users/bdol/Desktop/png_data/1146.2.N/IM_For_Katie_0.png');
im_turned = imread('/Users/bdol/Desktop/png_data/1146.2.N/IM_9_3.png');

[R L R_rect L_rect] = rectify_eyes(canon_corresp, turned_corresp, 100, 50, im_canon, im_turned);
close all;
subplot(2, 2, 1); imshow(R);
subplot(2, 2, 2); imshow(L);
subplot(2, 2, 3); imshow(R_rect/255);
subplot(2, 2, 4); imshow(L_rect/255);

%% Test a bunch of images
clear; close all;
fbase = '~/Desktop/out_rect/';
flist = dir(fbase);
f_canon = flist(4).name;
c_canon = importdata([fbase f_canon]);

ibase = '/Users/bdol/Desktop/png_data/1146.2.N/';
ilist = importdata('~/code/eyetrack/util/face_tracker/src/exe/frames.txt');

im_canon = imread(ilist{1});

for i=5:33
    im_turned = imread(ilist{i-3});
    c_turned = importdata([fbase flist(i).name]);
        
    [R L R_rect L_rect c_trans_r c_trans_l cr cl] = rectify_eyes(c_canon, c_turned, 100, 50, im_canon, im_turned);
    close all;
    subplot(2, 2, 1); imshow(R); hold on;
    for j=37:42
        plot(c_canon(j, 1)-cr(1), c_canon(j, 2)-cr(2), 'bo'); hold on;
        plot(c_trans_r(j-36, 1), c_trans_r(j-36, 2), 'gx'); hold on;
    end
    hold off;
    subplot(2, 2, 2); imshow(L); hold on;
    for j=43:48
        plot(c_canon(j, 1)-cl(1), c_canon(j, 2)-cl(2), 'bo'); hold on;
        plot(c_trans_l(j-42, 1), c_trans_l(j-42, 2), 'gx'); hold on;
    end
    hold off;
    subplot(2, 2, 3); imshow(R_rect/255); hold on;
    for j=1:6
        plot(c_trans_r(j, 1), c_trans_r(j, 2), 'gx'); hold on;
    end
    hold off;
    subplot(2, 2, 4); imshow(L_rect/255); hold on;
    for j=1:6
        plot(c_trans_l(j, 1), c_trans_l(j, 2), 'gx'); hold on;
    end
    hold off;
    keyboard;
    
end